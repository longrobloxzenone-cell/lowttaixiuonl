<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casino-Luxury-V42-Redirect</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* T·ªîNG TH·ªÇ LUXURY */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; -webkit-user-select: none; user-select: none; }
        body { background: radial-gradient(circle, #4a0000 0%, #000 100%); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow-x: hidden; height: 100vh; }
        #loginPanel, #gamePanel, #loadingPanel { width: 100%; max-width: 500px; margin: 0 auto; padding: 15px; }

        /* M√ÄN H√åNH CH·ªú */
        #loadingPanel { height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 99999; }
        .spinner { width: 45px; height: 45px; border: 5px solid #ffd70033; border-top: 5px solid #ffd700; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LOGIN LUXURY - FIX HI·ªÇN TH·ªä */
        #loginPanel { height: 100vh; display: none; align-items: center; justify-content: center; }
        .login-card { background: rgba(15, 15, 15, 0.95); padding: 40px 30px; border-radius: 30px; border: 2px solid #ffd700; width: 100%; text-align: center; backdrop-filter: blur(15px); box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; background: #111; border: 1px solid #ffd70033; color: #fff; font-size: 16px; }
        .btn-action { width: 100%; padding: 18px; background: linear-gradient(to right, #ffd700, #b8860b); border: none; border-radius: 12px; color: #000; font-weight: 900; cursor: pointer; text-transform: uppercase; }

        /* GAME UI */
        #gamePanel { display: none; }
        #money { font-size: 45px; color: #4caf50; font-weight: bold; text-align: center; margin: 10px 0; text-shadow: 0 0 15px rgba(76,175,80,0.6); }
        .dice { width: 70px; height: 70px; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 38px; color: #000; box-shadow: 0 5px 15px #000; margin: 0 5px; }

        /* CHIP C∆Ø·ª¢C */
        #chipArea { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .chip { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #fff; font-size: 9px; transition: 0.2s; cursor: pointer; box-shadow: 0 3px 10px #000; }
        .chip.selected { border: 3.5px solid #ffd700; transform: scale(1.15); box-shadow: 0 0 15px #ffd700; }
        .chip.disabled { opacity: 0.15; filter: grayscale(1); pointer-events: none; }

        /* M√ÄU CHIP */
        .chip[data-value="1000"] { background: #4caf50; } .chip[data-value="2000"] { background: #8bc34a; } .chip[data-value="5000"] { background: #009688; }
        .chip[data-value="10000"] { background: #ff9800; } .chip[data-value="100000"] { background: #795548; } .chip[data-value="500000"] { background: #e91e63; }
        .chip[data-value="1000000"] { background: #2196f3; } .chip[data-value="5000000"] { background: #9c27b0; } .chip[data-value="10000000"] { background: #b71c1c; }
        .chip[data-value="50000000"] { background: #fbc02d; color:#000; } .chip[data-value="100000000"] { background: #00bcd4; } .chip[data-value="500000000"] { background: #eee; color:#000; }

        /* ADMIN CONTROL */
        #adminPanel { margin-top: 40px; padding: 20px; background: rgba(10, 10, 10, 0.98); border: 2px solid #ffd700; border-radius: 30px; display: none; }
        .admin-card { background: rgba(255,255,255,0.04); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,215,0,0.15); }
        .admin-status { font-size: 13px; margin-bottom: 10px; color: #ccc; background: #000; padding: 8px; border-radius: 8px; }
        .admin-status b { color: #ffd700; }
        .admin-btn { padding: 12px; font-size: 11px; font-weight: bold; border-radius: 8px; flex: 1; color: #fff; border: none; cursor: pointer; margin: 2px; }
        .u-input { width: 80px; background: #000; border: 1px solid #444; color: #4caf50; padding: 8px; border-radius: 6px; font-size: 12px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="loadingPanel">
    <div class="spinner"></div>
    <p style="color:#ffd700; margin-top:20px; font-weight:bold; letter-spacing: 1px;">ƒêANG KI·ªÇM TRA PHI√äN L√ÄM VI·ªÜC...</p>
</div>

<div id="loginPanel">
    <div class="login-card">
        <h2 style="color:#ffd700; letter-spacing: 2px;">LUXURY ACCESS</h2>
        <input type="text" id="username" class="login-input" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="password" class="login-input" placeholder="M·∫≠t kh·∫©u">
        <button onclick="login()" class="btn-action">ƒêƒÇNG NH·∫¨P NGAY</button>
        <button onclick="register()" style="background:none; border:none; color:#888; margin-top:20px; cursor:pointer; font-size:12px;">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω nh·∫≠n 1M$</button>
    </div>
</div>

<div id="gamePanel">
    <div style="text-align: center; padding: 5px; border-bottom: 1px solid rgba(255,215,0,0.1); margin-bottom: 10px;">
        <span id="displayWelcome" style="color:#ffd700; font-weight:bold;">üë§ ƒêang t·∫£i...</span>
        <button onclick="logout()" style="background:#333; color:#fff; padding:5px 10px; border-radius:8px; border:none; margin-left:10px; font-size:10px; cursor:pointer;">Tho√°t</button>
    </div>
    <div id="money">0 $</div>
    <div id="historyList" style="display:flex; justify-content:center; gap:5px; margin-bottom:15px; flex-wrap:wrap;"></div>
    <div style="display:flex; justify-content:center; margin: 15px 0;"><div id="dice1" class="dice">üé≤</div><div id="dice2" class="dice">üé≤</div><div id="dice3" class="dice">üé≤</div></div>
    <div id="resultText" style="text-align:center; font-weight:bold; height: 30px; color: #ffd700;">H√¥m nay b·∫°n c∆∞·ª£c g√¨?</div>

    <div id="chipArea">
        <div class="chip" data-value="1000">1K</div><div class="chip" data-value="2000">2K</div><div class="chip" data-value="5000">5K</div>
        <div class="chip" data-value="10000">10K</div><div class="chip" data-value="100000">100K</div><div class="chip" data-value="500000">500K</div>
        <div class="chip" data-value="1000000">1M</div><div class="chip" data-value="5000000">5M</div><div class="chip" data-value="10000000">10M</div>
        <div class="chip" data-value="100000000">100M</div><div class="chip" data-value="500000000">500M</div>
    </div>
    
    <div style="display:flex; justify-content: space-between;"><button onclick="chooseBet('T√†i')" style="width:48%; padding:15px; background:#ff5722; color:#fff; font-weight:bold; border-radius:12px; border:none;">T√ÄI</button><button onclick="chooseBet('X·ªâu')" style="width:48%; padding:15px; background:#2196f3; color:#fff; font-weight:bold; border-radius:12px; border:none;">X·ªàU</button></div>
    <button id="btnRoll" onclick="rollDice()" style="width:100%; padding:22px; background:linear-gradient(#ffd700, #b8860b); color:#000; font-weight:900; border-radius:15px; border:none; margin-top:10px;">QUAY TH∆Ø·ªûNG</button>

    <div id="adminPanel">
        <h2 style="color:#ffd700; text-align:center; font-size: 18px; margin-top:0;">SUPER ADMIN DASHBOARD</h2>
        <div class="admin-card">
            <div style="color:#ffd700; font-size:12px; font-weight:bold; margin-bottom:10px;">üìä T·ªà L·ªÜ TH·∫ÆNG KH√îNG GI·ªöI H·∫†N</div>
            <div class="admin-status">T·ªâ l·ªá hi·ªán t·∫°i: <b id="winRateDisplay">--</b>%</div>
            <div style="display:flex; gap:5px;"><input type="number" id="inputWinRate" style="flex:1; background:#000; color:#fff; border:1px solid #444; padding:10px; border-radius:8px;"><button onclick="adminSetWinRate()" style="background:#2e7d32; color:#fff; border:none; padding:10px 20px; border-radius:8px;">L∆ØU</button></div>
        </div>
        <div id="cardForce" class="admin-card" style="display:none;"><div style="color:#ffd700; font-size:12px; font-weight:bold; margin-bottom:10px;">üéØ √âP K·∫æT QU·∫¢</div><div style="display:flex; gap:5px;"><button onclick="setForce('T√†i')" class="admin-btn" style="background:#e65100;">T√ÄI</button><button onclick="setForce('X·ªâu')" class="admin-btn" style="background:#0d47a1;">X·ªàU</button><button onclick="setForce(null)" class="admin-btn" style="background:#444;">H·ª¶Y</button></div></div>
        <div id="cardUsers" class="admin-card" style="display:none;"><div style="color:#ffd700; font-size:12px; font-weight:bold; margin-bottom:10px;">üë• NG∆Ø·ªúI CH∆†I</div><div id="userList"></div></div>
    </div>
</div>

<script>
// ANTI-F12
document.onkeydown = function(e) { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) return false; };

const firebaseConfig = {
  apiKey: "AIzaSyCbESIH8uq5Q6R45ehisGp-Lsh9xz_ejDk",
  authDomain: "tx888-85658.firebaseapp.com",
  databaseURL: "https://tx888-85658-default-rtdb.firebaseio.com",
  projectId: "tx888-85658",
  storageBucket: "tx888-85658.firebasestorage.app",
  messagingSenderId: "246211516842",
  appId: "1:246211516842:web:24a3598d54b037676c73d3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database(), auth = firebase.auth();
let userData = null, selectedAmount = 1000, selectedChoice = null, serverState = {}, isRolling = false;

// --- C∆† CH·∫æ AUTO LOG TH√îNG MINH (V42) ---
let checkLogTimeout = setTimeout(() => {
    if (!userData) {
        console.log("Kh√¥ng th·∫•y Log - Redirect sang Login");
        document.getElementById("loadingPanel").style.display = "none";
        document.getElementById("loginPanel").style.display = "flex";
        document.getElementById("gamePanel").style.display = "none";
    }
}, 3000); // Sau 3 gi√¢y kh√¥ng th·∫•y data th√¨ hi·ªán b·∫£ng Login

auth.onAuthStateChanged((user) => {
    if (user) {
        loadUserData(user.uid);
    } else {
        clearTimeout(checkLogTimeout);
        document.getElementById("loadingPanel").style.display = "none";
        document.getElementById("loginPanel").style.display = "flex";
        document.getElementById("gamePanel").style.display = "none";
    }
});

function login() {
    const u = document.getElementById("username").value.trim().toLowerCase(), p = document.getElementById("password").value.trim();
    if(!u || !p) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!");
    auth.signInWithEmailAndPassword(u + "@casino.com", p).catch(() => alert("Sai th√¥ng tin!"));
}

async function register() {
    const u = document.getElementById("username").value.trim().toLowerCase(), p = document.getElementById("password").value.trim();
    if(u.length < 3) return alert("T√™n qu√° ng·∫Øn!");
    try {
        const res = await auth.createUserWithEmailAndPassword(u + "@casino.com", p);
        await db.ref('users/' + res.user.uid).set({ username: u, money: 1000000, isAdmin: false, isSuperAdmin: false });
        alert("Th√†nh c√¥ng! Nh·∫≠n 1M$");
    } catch (e) { alert("L·ªói: " + e.message); }
}

function loadUserData(uid) {
    db.ref('users/' + uid).on('value', (s) => {
        userData = s.val(); if(!userData) return;
        clearTimeout(checkLogTimeout);
        userData.uid = uid;
        document.getElementById("loadingPanel").style.display = "none";
        document.getElementById("loginPanel").style.display = "none";
        document.getElementById("gamePanel").style.display = "block";
        document.getElementById("displayWelcome").innerText = `üë§ ${userData.username}`;
        
        if(userData.isAdmin || userData.isSuperAdmin) {
            document.getElementById("adminPanel").style.display = "block";
            document.getElementById("cardForce").style.display = "block";
            document.getElementById("cardUsers").style.display = "block";
            loadAllUsers();
        }
        updateUI();
    });
}

function updateUI() {
    if(!userData) return;
    document.getElementById("money").innerText = userData.money.toLocaleString() + " $";
    document.querySelectorAll(".chip").forEach(chip => {
        if (userData.money < parseInt(chip.dataset.value)) chip.classList.add("disabled");
        else chip.classList.remove("disabled");
    });
}

db.ref('server').on('value', (s) => { 
    serverState = s.val() || { winRate: 20 }; 
    const wr = document.getElementById("winRateDisplay"); if(wr) wr.innerText = serverState.winRate;
});

db.ref('history').limitToLast(15).on('value', (s) => {
    let html = ""; const data = s.val();
    if(data) Object.values(data).forEach(item => { html += `<div style="width:20px;height:20px;border-radius:50%;background:${item.res=='T√†i'?'#ff5722':'#2196f3'};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;border:1px solid #fff;">${item.res[0]}</div>`; });
    document.getElementById("historyList").innerHTML = html;
});

function loadAllUsers() {
    db.ref('users').on('value', (s) => {
        let html = ""; const users = s.val();
        for (let uid in users) {
            const u = users[uid]; const isMe = (uid === userData.uid);
            const b = u.isSuperAdmin ? `<span style="color:#ff0000;font-size:10px;font-weight:bold;">(SAD)</span>` : (u.isAdmin ? `<span style="color:#ffff00;font-size:10px;font-weight:bold;">(AD)</span>` : `<span style="color:#888;font-size:10px;">(Member)</span>`);
            const mP = !u.isSuperAdmin ? `<button onclick="tAdmin('${uid}',${u.isAdmin})" style="background:blue;color:#fff;border:none;padding:8px;border-radius:6px;font-size:10px;">AD</button><button onclick="delU('${uid}','${u.username}')" style="background:#444;color:#fff;border:none;padding:8px;border-radius:6px;font-size:10px;">X</button>` : "";
            html += `<div class="user-item" style="background:rgba(255,255,255,0.02); padding:10px; border-radius:10px; margin-bottom:5px;"><div style="display:flex;justify-content:space-between;font-size:13px;"><b>${u.username} ${b} ${isMe?'(B·∫†N)':''}</b><span>${u.money.toLocaleString()} $</span></div>
            <div style="display:flex; gap:5px; margin-top:10px;"><input type="number" id="amt_${uid}" class="u-input" placeholder="Ti·ªÅn..."><button onclick="editM('${uid}',1)" style="background:green;color:#fff;border:none;padding:8px;border-radius:6px;">+</button><button onclick="editM('${uid}',-1)" style="background:red;color:#fff;border:none;padding:8px;border-radius:6px;">-</button>${mP}</div></div>`;
        }
        document.getElementById("userList").innerHTML = html;
    });
}

function adminSetWinRate() { 
    const newVal = parseInt(document.getElementById("inputWinRate").value);
    if(isNaN(newVal)) return alert("Nh·∫≠p s·ªë!");
    db.ref('server').update({ winRate: newVal }).then(()=>alert("ƒê√£ l∆∞u t·ªâ l·ªá!")); 
}

function editM(uid, type) {
    const amt = parseInt(document.getElementById("amt_" + uid).value);
    if(!amt || amt <= 0) return alert("Nh·∫≠p s·ªë!");
    db.ref('users/' + uid + '/money').once('value', s => {
        let n = (type === 1) ? s.val() + amt : s.val() - amt;
        db.ref('users/' + uid).update({ money: Math.max(0, n) });
    });
}
function setForce(f) { db.ref('server').update({ forcedResult: f }); }
function tAdmin(uid, cur) { db.ref('users/' + uid).update({ isAdmin: !cur }); }
function delU(uid, name) { if(confirm("X√≥a " + name + "?")) db.ref('users/' + uid).remove(); }
function logout() { auth.signOut().then(() => location.reload()); }
function chooseBet(c) { if(!isRolling) { selectedChoice = c; document.getElementById("resultText").innerText = "ƒê√£ ch·ªçn: " + c; } }
function rollDice() {
    if(isRolling || !selectedChoice || userData.money < selectedAmount) return alert("Ki·ªÉm tra ti·ªÅn c∆∞·ª£c!");
    isRolling = true; document.getElementById("btnRoll").disabled = true;
    userData.money -= selectedAmount; updateUI();
    db.ref('users/' + userData.uid).update({ money: userData.money });
    let d, sum, res, limit = 0;
    const curWR = (serverState.winRate !== undefined) ? serverState.winRate / 100 : 0.2;
    do {
        d = [Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1];
        sum = d[0]+d[1]+d[2]; res = sum >= 11 ? "T√†i" : "X·ªâu"; limit++;
        let cond = serverState.forcedResult ? (res === serverState.forcedResult) : (Math.random() < curWR ? res === selectedChoice : res !== selectedChoice);
        if(cond || limit > 100) break;
    } while(true);
    animate(d, sum, res);
}
function animate(dice, total, finalRes) {
    let count = 0;
    let t = setInterval(() => {
        document.getElementById("dice1").innerText = Math.floor(Math.random()*6)+1;
        document.getElementById("dice2").innerText = Math.floor(Math.random()*6)+1;
        document.getElementById("dice3").innerText = Math.floor(Math.random()*6)+1;
        if(count++ > 12) {
            clearInterval(t);
            document.getElementById("dice1").innerText = dice[0]; document.getElementById("dice2").innerText = dice[1]; document.getElementById("dice3").innerText = dice[2];
            let win = (selectedChoice === finalRes);
            if(win) { userData.money += (selectedAmount * 2); db.ref('users/' + userData.uid).update({ money: userData.money }); }
            updateUI();
