<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casino T√†i X·ªâu - B·∫£n M∆∞·ª£t 100%</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: radial-gradient(circle, #8b0000 0%, #000 100%); color: #fff; font-family: sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        #loginPanel, #gamePanel { width: 100%; max-width: 500px; margin: 0 auto; padding: 20px; }
        h2 { font-size: 1.8rem; text-transform: uppercase; margin-bottom: 20px; color: #ffd700; text-align: center; }
        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; border: 1px solid #444; background: #1a1a1a; color: #fff; font-size: 16px; }
        button { cursor: pointer; border-radius: 10px; border: none; font-weight: bold; transition: 0.2s; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #money { font-size: 40px; color: #4caf50; font-weight: bold; text-align: center; margin: 15px 0; }
        #diceArea { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .dice { width: 75px; height: 75px; background: #fff; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #000; box-shadow: 0 5px 15px #000; }
        #chipArea { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 15px 0; }
        .chip { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #fff; font-size: 12px; }
        .chip.selected { border: 4px solid #ffd700; transform: scale(1.2); box-shadow: 0 0 15px #ffd700; }
        .chip.disabled { opacity: 0.2; pointer-events: none; }
        .chip[data-value="1000"] { background: #4caf50; } .chip[data-value="1000000"] { background: #2196f3; }
        .chip[data-value="5000000"] { background: #8e24aa; } .chip[data-value="10000000"] { background: #b71c1c; }
        .action-btn { width: 48%; padding: 18px; font-size: 20px; color: #fff; margin-bottom: 15px; }
        #btnRoll { width: 100%; padding: 20px; font-size: 22px; background: #ffd700; color: #000; margin-top: 10px; }
        #adminPanel { margin-top: 40px; padding: 20px; background: rgba(0,0,0,0.9); border: 2px solid #ffd700; border-radius: 20px; display: none; }
        .user-card { background: #262626; padding: 12px; margin: 8px 0; border-radius: 10px; font-size: 14px; border-left: 5px solid #ffd700; }
        .lock-banner { background: #ff0000; color: #fff; padding: 12px; font-weight: bold; border-radius: 8px; margin-bottom: 15px; display: none; text-align: center; }
    </style>
</head>
<body>

<div id="loginPanel">
    <h2>CASINO ONLINE</h2>
    <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="login()" style="width:100%; padding:16px; background:#ffd700; color:#000;">ƒêƒÇNG NH·∫¨P</button>
    <button onclick="register()" style="width:100%; padding:12px; background:transparent; color:#888; margin-top:15px;">ƒêƒÉng k√Ω t√†i kho·∫£n</button>
</div>

<div id="gamePanel" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span id="displayUserName" style="color:#ffd700; font-weight:bold;">üë§ T·∫£i d·ªØ li·ªáu...</span>
        <button onclick="logout()" style="background:#333; color:#fff; padding:6px 12px; font-size:12px;">Tho√°t</button>
    </div>
    <div id="money">0</div>
    <div id="lockBanner" class="lock-banner">‚ö†Ô∏è M√ÅY ƒêANG B·∫¢O TR√å ‚ö†Ô∏è</div>
    <div id="diceArea">
        <div id="dice1" class="dice">üé≤</div><div id="dice2" class="dice">üé≤</div><div id="dice3" class="dice">üé≤</div>
    </div>
    <div id="resultText" style="text-align:center; font-weight:bold; height:35px; color:#ffd700; font-size:18px;">M·ªùi ƒë·∫∑t c∆∞·ª£c!</div>
    <div id="chipArea">
        <div class="chip" data-value="1000">1K</div><div class="chip" data-value="1000000">1M</div>
        <div class="chip" data-value="5000000">5M</div><div class="chip" data-value="10000000">10M</div>
    </div>
    <div id="selectedBet" style="text-align:center; margin:15px; font-size:14px; background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; color:#aaa;">C∆∞·ª£c: 0 | C·ª≠a: -</div>
    <div style="display:flex; justify-content: space-between;">
        <button onclick="chooseBet('T√†i')" class="action-btn" style="background:#ff5722;">T√ÄI</button>
        <button onclick="chooseBet('X·ªâu')" class="action-btn" style="background:#2196f3;">X·ªàU</button>
    </div>
    <button id="btnRoll" onclick="rollDice()">QUAY TH∆Ø·ªûNG</button>

    <div id="adminPanel">
        <h3 style="color:#ffd700; text-align:center;">QU·∫¢N TR·ªä VI√äN</h3>
        <div style="border-bottom: 1px solid #333; padding:10px 0;">
            M√°y: <span id="lockStatus" style="color:lime">M·ªû</span><br>
            <button onclick="adminToggleLock(true)" style="background:#d32f2f; color:#fff; padding:8px; margin-top:5px;">KH√ìA</button>
            <button onclick="adminToggleLock(false)" style="background:#388e3c; color:#fff; padding:8px; margin-top:5px;">M·ªû</button>
        </div>
        <div style="border-bottom: 1px solid #333; padding:10px 0;">
            √âp: <span id="forceStatus" style="color:cyan">T·ª∞ NHI√äN</span><br>
            <button onclick="setForce('T√†i')" style="background:#ef6c00; padding:8px; margin-top:5px;">T√ÄI</button>
            <button onclick="setForce('X·ªâu')" style="background:#1565c0; padding:8px; margin-top:5px;">X·ªàU</button>
            <button onclick="setForce(null)" style="background:#555; padding:8px; margin-top:5px;">H·ª¶Y</button>
        </div>
        <strong>DANH S√ÅCH USER:</strong>
        <div id="userList" style="margin-top:10px; max-height:250px; overflow-y:auto;"></div>
    </div>
</div>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyCbESIH8uq5Q6R45ehisGp-Lsh9xz_ejDk",
    authDomain: "tx888-85658.firebaseapp.com",
    databaseURL: "https://tx888-85658-default-rtdb.firebaseio.com",
    projectId: "tx888-85658",
    storageBucket: "tx888-85658.firebasestorage.app",
    messagingSenderId: "246211516842",
    appId: "1:246211516842:web:24a3598d54b037676c73d3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database(), auth = firebase.auth();

let userData = null, selectedAmount = 0, selectedChoice = null, serverState = {}, isRolling = false;
const winRate = 0.2; // 20% th·∫Øng

db.ref('server').on('value', s => { serverState = s.val() || {}; updateUI(); });

function login() {
    const u = document.getElementById("username").value.trim().toLowerCase(), p = document.getElementById("password").value;
    if(!u || !p) return;
    auth.signInWithEmailAndPassword(u + "@casino.com", p).then(res => loadUserData(res.user.uid)).catch(() => alert("Sai th√¥ng tin!"));
}

function register() {
    const u = document.getElementById("username").value.trim().toLowerCase(), p = document.getElementById("password").value;
    if(u.length < 3) return alert("T√™n qu√° ng·∫Øn!");
    auth.createUserWithEmailAndPassword(u + "@casino.com", p).then(res => {
        db.ref('users/' + res.user.uid).set({ username: u, money: 2000000, isAdmin: false });
        alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
    }).catch(() => alert("T√™n ƒë√£ t·ªìn t·∫°i!"));
}

function loadUserData(uid) {
    db.ref('users/' + uid).on('value', s => {
        userData = s.val(); if(!userData) return;
        userData.uid = uid;
        document.getElementById("loginPanel").style.display = "none";
        document.getElementById("gamePanel").style.display = "block";
        document.getElementById("displayUserName").innerText = "üë§ " + userData.username + (userData.isAdmin ? " (Admin)" : "");
        if(userData.isAdmin) { document.getElementById("adminPanel").style.display = "block"; loadAllUsers(); }
        updateUI();
    });
}

function updateUI() {
    if(!userData) return;
    document.getElementById("money").innerText = userData.money.toLocaleString() + " $";
    document.getElementById("selectedBet").innerText = `C∆∞·ª£c: ${selectedAmount.toLocaleString()} | C·ª≠a: ${selectedChoice || "-"}`;
    document.getElementById("lockBanner").style.display = serverState.isLocked ? "block" : "none";
    document.getElementById("lockStatus").innerText = serverState.isLocked ? "KH√ìA" : "M·ªû";
    document.getElementById("forceStatus").innerText = serverState.forcedResult || "T·ª∞ NHI√äN";
    if(!isRolling) {
        document.getElementById("btnRoll").disabled = (serverState.isLocked && !userData.isAdmin);
        document.querySelectorAll(".chip").forEach(c => {
            if(userData.money < parseInt(c.dataset.value)) c.classList.add("disabled");
            else c.classList.remove("disabled");
        });
    }
}

document.querySelectorAll(".chip").forEach(c => {
    c.onclick = function() {
        selectedAmount = parseInt(this.dataset.value);
        document.querySelectorAll(".chip").forEach(x => x.classList.remove("selected"));
        this.classList.add("selected");
        updateUI();
    }
});

function chooseBet(c) { selectedChoice = c; updateUI(); }

function rollDice() {
    if(isRolling) return;
    if(!selectedChoice || selectedAmount <= 0) return alert("Vui l√≤ng ƒë·∫∑t c∆∞·ª£c!");
    if(userData.money < selectedAmount) return alert("Kh√¥ng ƒë·ªß ti·ªÅn!");
    
    // B·∫Øt ƒë·∫ßu quay
    isRolling = true;
    const btn = document.getElementById("btnRoll");
    btn.disabled = true; btn.innerText = "ƒêANG L·∫ÆC...";
    document.querySelectorAll(".chip").forEach(c => c.classList.add("disabled"));

    // T√çNH TO√ÅN TR∆Ø·ªöC ƒê·ªÇ FIX LAG
    let d = [r(), r(), r()], sum = d[0]+d[1]+d[2], res = sum >= 11 ? "T√†i" : "X·ªâu";
    if(serverState.forcedResult) {
        while(res !== serverState.forcedResult) { d=[r(),r(),r()]; sum=d[0]+d[1]+d[2]; res=sum>=11?"T√†i":"X·ªâu"; }
    } else if(Math.random() > winRate) { // Thua
        while(res === selectedChoice) { d=[r(),r(),r()]; sum=d[0]+d[1]+d[2]; res=sum>=11?"T√†i":"X·ªâu"; }
    } else { // Th·∫Øng
        while(res !== selectedChoice) { d=[r(),r(),r()]; sum=d[0]+d[1]+d[2]; res=sum>=11?"T√†i":"X·ªâu"; }
    }
    animate(d, sum, res);
}

function r() { return Math.floor(Math.random() * 6) + 1; }

function animate(dice, total, finalRes) {
    let count = 0;
    const resText = document.getElementById("resultText");
    resText.innerText = "ƒêang l·∫Øc...";
    let t = setInterval(() => {
        document.getElementById("dice1").innerText = r(); document.getElementById("dice2").innerText = r(); document.getElementById("dice3").innerText = r();
        if(count++ > 12) {
            clearInterval(t);
            document.getElementById("dice1").innerText = dice[0]; document.getElementById("dice2").innerText = dice[1]; document.getElementById("dice3").innerText = dice[2];
            let win = (selectedChoice === finalRes);
            let newMoney = win ? userData.money + selectedAmount : userData.money - selectedAmount;
            
            // L∆ØU D·ªÆ LI·ªÜU CH·∫†Y NG·∫¶M
            db.ref('users/' + userData.uid).update({ money: Math.max(0, newMoney) }).then(() => {
                isRolling = false;
                const btn = document.getElementById("btnRoll");
                btn.disabled = false; btn.innerText = "QUAY TH∆Ø·ªûNG";
                resText.innerText = `K·∫æT QU·∫¢: ${finalRes} (${total})`;
                resText.style.color = win ? "#4caf50" : "#f44336";
                updateUI();
            });
        }
    }, 60);
}

// ADMIN TOOLS
function adminToggleLock(s) { db.ref('server').update({ isLocked: s }); }
function setForce(f) { db.ref('server').update({ forcedResult: f }); }
function loadAllUsers() {
    db.ref('users').on('value', s => {
        let html = ""; const data = s.val();
        for(let id in data) {
            html += `<div class="user-card"><strong>${data[id].username}</strong> | $: ${data[id].money.toLocaleString()}<br>
            <button onclick="editM('${id}', 1000000)" style="background:green;color:white;padding:5px;margin-top:5px;">+1M</button>
            <button onclick="tAdmin('${id}', ${data[id].isAdmin})" style="background:blue;color:white;padding:5px;">Admin: ${data[id].isAdmin}</button></div>`;
        }
        document.getElementById("userList").innerHTML = html;
    });
}
function editM(id, a) { db.ref('users/'+id+'/money').once('value', s => db.ref('users/'+id).update({ money: s.val() + a })); }
function tAdmin(id, c) { if(id === userData.uid) return alert("Kh√¥ng th·ªÉ t·ª± h·ªßy quy·ªÅn Admin!"); db.ref('users/'+id).update({ isAdmin: !c }); }
function logout() { auth.signOut().then(() => location.reload()); }
</script>
</body>
</html>

