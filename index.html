<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casino-Luxury-V43-Force-UI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* T·ªîNG TH·ªÇ */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: radial-gradient(circle, #4a0000 0%, #000 100%); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow: hidden; height: 100vh; }
        
        /* M√ÄN H√åNH CH·ªú C∆Ø·ª†NG CH·∫æ */
        #loadingPanel { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ffd70033; border-top: 4px solid #ffd700; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* GIAO DI·ªÜN LOGIN - HI·ªÇN TH·ªä TRUNG T√ÇM */
        #loginPanel { height: 100vh; display: none; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: rgba(15, 15, 15, 0.98); padding: 40px 30px; border-radius: 30px; border: 2px solid #ffd700; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .login-input { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; background: #000; border: 1px solid #ffd70044; color: #fff; font-size: 16px; }
        .btn-main { width: 100%; padding: 18px; background: linear-gradient(to right, #ffd700, #b8860b); border: none; border-radius: 12px; color: #000; font-weight: 900; cursor: pointer; text-transform: uppercase; }

        /* GIAO DI·ªÜN GAME */
        #gamePanel { display: none; height: 100vh; overflow-y: auto; padding: 15px; width: 100%; max-width: 500px; margin: 0 auto; }
        #money { font-size: 45px; color: #4caf50; font-weight: bold; text-align: center; margin: 10px 0; text-shadow: 0 0 15px rgba(76,175,80,0.6); }
        
        /* CHIP C∆Ø·ª¢C PH·ª§C H·ªíI 13 M·ª®C */
        #chipArea { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .chip { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #fff; font-size: 9px; transition: 0.2s; cursor: pointer; }
        .chip.selected { border: 3.5px solid #ffd700; transform: scale(1.1); box-shadow: 0 0 15px #ffd700; }
        .chip.disabled { opacity: 0.2; filter: grayscale(1); pointer-events: none; }
        /* B·∫£ng m√†u chip chu·∫©n */
        .chip[data-value="1000"] { background: #4caf50; } .chip[data-value="2000"] { background: #8bc34a; } .chip[data-value="5000"] { background: #009688; }
        .chip[data-value="10000"] { background: #ff9800; } .chip[data-value="100000"] { background: #795548; } .chip[data-value="500000"] { background: #e91e63; }
        .chip[data-value="1000000"] { background: #2196f3; } .chip[data-value="10000000"] { background: #b71c1c; } .chip[data-value="500000000"] { background: #eee; color:#000; }

        /* ADMIN PANEL */
        #adminPanel { background: rgba(10, 10, 10, 0.95); border: 2px solid #ffd700; border-radius: 25px; padding: 15px; margin-top: 30px; display: none; }
        .admin-card { background: #1a1a1a; padding: 12px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #333; }
        .u-input { width: 75px; background: #000; border: 1px solid #444; color: #4caf50; padding: 8px; border-radius: 8px; }
    </style>
</head>
<body>

<div id="loadingPanel"><div class="spinner"></div></div>

<div id="loginPanel">
    <div class="login-card">
        <h2 style="color:#ffd700; margin-bottom: 30px;">ROYAL LOGIN</h2>
        <input type="text" id="username" class="login-input" placeholder="T√™n t√†i kho·∫£n">
        <input type="password" id="password" class="login-input" placeholder="M·∫≠t kh·∫©u">
        <button onclick="login()" class="btn-main" style="margin-bottom: 10px;">ƒêƒÇNG NH·∫¨P</button>
        <button onclick="register()" style="background:none; border:none; color:#888; font-size:12px; cursor:pointer;">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω t·∫∑ng 1M$</button>
    </div>
</div>

<div id="gamePanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span id="displayWelcome" style="color:#ffd700; font-weight:bold;">üë§ ƒêang t·∫£i...</span>
        <button onclick="logout()" style="background:#333; color:#fff; border:none; padding:5px 10px; border-radius:8px;">Tho√°t</button>
    </div>
    <div id="money">0 $</div>
    <div style="display:flex; justify-content:center; margin: 20px 0;"><div id="dice1" style="font-size:50px; margin:0 10px;">üé≤</div><div id="dice2" style="font-size:50px; margin:0 10px;">üé≤</div><div id="dice3" style="font-size:50px; margin:0 10px;">üé≤</div></div>
    
    <div id="chipArea">
        <div class="chip" data-value="1000">1K</div><div class="chip" data-value="5000">5K</div><div class="chip" data-value="10000">10K</div>
        <div class="chip" data-value="100000">100K</div><div class="chip" data-value="1000000">1M</div><div class="chip" data-value="10000000">10M</div>
        <div class="chip" data-value="100000000">100M</div><div class="chip" data-value="500000000">500M</div>
    </div>
    
    <div style="display:flex; justify-content: space-between;"><button onclick="chooseBet('T√†i')" style="width:48%; padding:15px; background:#ff5722; color:#fff; border:none; border-radius:10px; font-weight:bold;">T√ÄI</button><button onclick="chooseBet('X·ªâu')" style="width:48%; padding:15px; background:#2196f3; color:#fff; border:none; border-radius:10px; font-weight:bold;">X·ªàU</button></div>
    <button id="btnRoll" onclick="rollDice()" style="width:100%; padding:20px; background:linear-gradient(#ffd700, #b8860b); border:none; border-radius:15px; font-weight:900; margin-top:10px;">QUAY TH∆Ø·ªûNG</button>

    <div id="adminPanel">
        <div class="admin-card">
            <div style="color:#ffd700; font-weight:bold; margin-bottom:10px;">üìä T·ªà L·ªÜ TH·∫ÆNG HI·ªÜN T·∫†I: <span id="wrD">--</span>%</div>
            <div style="display:flex; gap:5px;"><input type="number" id="inputWinRate" style="flex:1; background:#000; color:#fff; border:1px solid #444; padding:8px;"><button onclick="adminSetWinRate()" style="background:#2e7d32; color:#fff; border:none; padding:8px 15px; border-radius:8px;">L∆ØU</button></div>
        </div>
        <div id="cardUsers" class="admin-card">
            <div style="color:#ffd700; font-weight:bold; margin-bottom:10px;">üë• QU·∫¢N L√ù NG∆Ø·ªúI CH∆†I</div>
            <div id="userList"></div>
        </div>
    </div>
</div>

<script>
// CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyCbESIH8uq5Q6R45ehisGp-Lsh9xz_ejDk",
  authDomain: "tx888-85658.firebaseapp.com",
  databaseURL: "https://tx888-85658-default-rtdb.firebaseio.com",
  projectId: "tx888-85658",
  storageBucket: "tx888-85658.firebasestorage.app",
  messagingSenderId: "246211516842",
  appId: "1:246211516842:web:24a3598d54b037676c73d3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database(), auth = firebase.auth();
let userData = null, selectedAmount = 1000, selectedChoice = null, serverState = {}, isRolling = false;

// --- B·ªò ƒêI·ªÄU H∆Ø·ªöNG C∆Ø·ª†NG CH·∫æ (ROUTER) ---
function showScreen(screenId) {
    document.getElementById("loadingPanel").style.display = "none";
    document.getElementById("loginPanel").style.display = "none";
    document.getElementById("gamePanel").style.display = "none";
    
    if(screenId === 'login') {
        document.getElementById("loginPanel").style.display = "flex";
    } else {
        document.getElementById("gamePanel").style.display = "block";
    }
}

// Ki·ªÉm tra tr·∫°ng th√°i log ngay khi t·∫£i trang
auth.onAuthStateChanged((user) => {
    if (user) {
        loadUserData(user.uid);
    } else {
        // N·∫øu kh√¥ng th·∫•y user, hi·ªán b·∫£n login ngay l·∫≠p t·ª©c
        showScreen('login');
    }
});

// Ch·ªëng k·∫πt m√†n h√¨nh Loading (Ph√≤ng h·ªù m·∫°ng lag)
setTimeout(() => {
    if (document.getElementById("loadingPanel").style.display !== "none") {
        console.warn("M·∫°ng lag - T·ª± ƒë·ªông m·ªü b·∫£n Login");
        showScreen('login');
    }
}, 3000);

function login() {
    const u = document.getElementById("username").value.trim().toLowerCase(), p = document.getElementById("password").value.trim();
    if(!u || !p) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß!");
    auth.signInWithEmailAndPassword(u + "@casino.com", p).catch(() => alert("Sai th√¥ng tin!"));
}

async function register() {
    const u = document.getElementById("username").value.trim().toLowerCase(), p = document.getElementById("password").value.trim();
    if(u.length < 3) return alert("T√™n qu√° ng·∫Øn!");
    try {
        const res = await auth.createUserWithEmailAndPassword(u + "@casino.com", p);
        await db.ref('users/' + res.user.uid).set({ username: u, money: 1000000, isAdmin: false, isSuperAdmin: false });
        alert("ƒêƒÉng k√Ω th√†nh c√¥ng! ƒê√£ t·∫∑ng 1.000.000$");
    } catch (e) { alert("L·ªói: " + e.message); }
}

function loadUserData(uid) {
    db.ref('users/' + uid).on('value', (s) => {
        userData = s.val(); 
        if(!userData) return showScreen('login');
        
        userData.uid = uid;
        document.getElementById("displayWelcome").innerText = `üë§ ${userData.username}`;
        
        if(userData.isAdmin || userData.isSuperAdmin) {
            document.getElementById("adminPanel").style.display = "block";
            loadAllUsers();
        }
        showScreen('game');
        updateUI();
    });
}

function updateUI() {
    if(!userData) return;
    document.getElementById("money").innerText = userData.money.toLocaleString() + " $";
}

db.ref('server').on('value', (s) => { 
    serverState = s.val() || { winRate: 20 }; 
    document.getElementById("wrD").innerText = serverState.winRate;
});

function adminSetWinRate() { 
    const v = parseInt(document.getElementById("inputWinRate").value);
    db.ref('server').update({ winRate: v }).then(()=>alert("ƒê√£ l∆∞u!")); 
}

function loadAllUsers() {
    db.ref('users').on('value', (s) => {
        let html = ""; const users = s.val();
        for (let uid in users) {
            const u = users[uid];
            const isMe = (uid === userData.uid);
            html += `<div class="user-item"><div style="display:flex; justify-content:space-between; font-size:13px;"><b>${u.username} ${isMe?'(B·∫†N)':''}</b><span>${u.money.toLocaleString()} $</span></div>
            <div style="display:flex; gap:5px; margin-top:5px;"><input type="number" id="amt_${uid}" class="u-input" placeholder="Ti·ªÅn..."><button onclick="editM('${uid}',1)" style="background:green; color:#fff; border:none; padding:5px; border-radius:5px;">+</button><button onclick="editM('${uid}',-1)" style="background:red; color:#fff; border:none; padding:5px; border-radius:5px;">-</button></div></div>`;
        }
        document.getElementById("userList").innerHTML = html;
    });
}

function editM(uid, type) {
    const amt = parseInt(document.getElementById("amt_" + uid).value);
    db.ref('users/' + uid + '/money').once('value', s => {
        let n = (type === 1) ? s.val() + amt : s.val() - amt;
        db.ref('users/' + uid).update({ money: Math.max(0, n) });
    });
}

function chooseBet(c) { selectedChoice = c; document.getElementById("resultText").innerText = "ƒê√£ ch·ªçn: " + c; }
function logout() { auth.signOut().then(() => location.reload()); }

function rollDice() {
    if(isRolling || !selectedChoice || userData.money < selectedAmount) return alert("Ki·ªÉm tra ti·ªÅn c∆∞·ª£c!");
    isRolling = true;
    userData.money -= selectedAmount; updateUI();
    db.ref('users/' + userData.uid).update({ money: userData.money });
    
    let d = [Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1];
    let sum = d[0]+d[1]+d[2];
    let res = sum >= 11 ? "T√†i" : "X·ªâu";
    
    setTimeout(() => {
        document.getElementById("dice1").innerText = d[0]; document.getElementById("dice2").innerText = d[1]; document.getElementById("dice3").innerText = d[2];
        if(res === selectedChoice) {
            userData.money += (selectedAmount * 2);
            db.ref('users/' + userData.uid).update({ money: userData.money });
        }
        isRolling = false;
        updateUI();
    }, 1000);
}
</script>
</body>
</html>
